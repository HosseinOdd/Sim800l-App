name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-jar:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'maven'
        
    - name: Build JAR
      run: mvn clean package -DskipTests
      
    - name: Upload JAR
      uses: actions/upload-artifact@v4
      with:
        name: jar-file
        path: target/SIM800LManager-v2.0.jar
        
    - name: Upload icon
      uses: actions/upload-artifact@v4
      with:
        name: app-icon
        path: src/main/resources/icons/app-icon.png

  build-linux:
    needs: build-jar
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Download JAR
      uses: actions/download-artifact@v4
      with:
        name: jar-file
        path: target/
        
    - name: Download icon
      uses: actions/download-artifact@v4
      with:
        name: app-icon
        path: icons/
        
    - name: Build Linux package with jpackage
      id: jpackage
      continue-on-error: true
      run: |
        jpackage \
          --input target \
          --name SIM800L-Manager \
          --main-jar SIM800LManager-v2.0.jar \
          --main-class com.sim800l.SIM800LApp \
          --type app-image \
          --dest dist/linux \
          --icon icons/app-icon.png \
          --java-options '-Xmx512m' \
          --app-version 2.0
          
    - name: Create fallback package (if jpackage failed)
      if: steps.jpackage.outcome == 'failure'
      run: |
        mkdir -p dist/linux/SIM800L-Manager
        cp target/SIM800LManager-v2.0.jar dist/linux/SIM800L-Manager/
        cp icons/app-icon.png dist/linux/SIM800L-Manager/
        cat > dist/linux/SIM800L-Manager/SIM800L-Manager << 'SCRIPT'
        #!/bin/bash
        DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        java -jar "$DIR/SIM800LManager-v2.0.jar" "$@"
        SCRIPT
        chmod +x dist/linux/SIM800L-Manager/SIM800L-Manager
        
    - name: Create Linux archive
      run: |
        cd dist/linux
        tar -czf SIM800L-Manager-linux-x64.tar.gz SIM800L-Manager
        
    - name: Upload Linux package
      uses: actions/upload-artifact@v4
      with:
        name: linux-package
        path: dist/linux/SIM800L-Manager-linux-x64.tar.gz

  build-windows:
    needs: build-jar
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Download JAR
      uses: actions/download-artifact@v4
      with:
        name: jar-file
        path: target/
        
    - name: Download icon
      uses: actions/download-artifact@v4
      with:
        name: app-icon
        path: icons/
        
    - name: Convert PNG to ICO
      shell: pwsh
      run: |
        # Install ImageMagick if not available, or use fallback
        if (Get-Command magick -ErrorAction SilentlyContinue) {
          magick convert icons/app-icon.png -define icon:auto-resize=256,128,96,64,48,32,16 icons/app-icon.ico
        } else {
          Write-Host "ImageMagick not found, copying PNG as fallback"
          Copy-Item icons/app-icon.png icons/app-icon.ico
        }
        
    - name: Build Windows package with jpackage
      id: jpackage
      continue-on-error: true
      shell: pwsh
      run: |
        $iconPath = if (Test-Path icons/app-icon.ico) { "icons/app-icon.ico" } else { "icons/app-icon.png" }
        jpackage `
          --input target `
          --name SIM800L-Manager `
          --main-jar SIM800LManager-v2.0.jar `
          --main-class com.sim800l.SIM800LApp `
          --type app-image `
          --dest dist/windows `
          --icon $iconPath `
          --java-options '-Xmx512m' `
          --app-version 2.0
          
    - name: Create fallback package (if jpackage failed)
      if: steps.jpackage.outcome == 'failure'
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path dist/windows/SIM800L-Manager
        Copy-Item target/SIM800LManager-v2.0.jar dist/windows/SIM800L-Manager/
        Copy-Item icons/app-icon.png dist/windows/SIM800L-Manager/
        @'
        @echo off
        java -jar "%~dp0SIM800LManager-v2.0.jar" %*
        '@ | Set-Content -Path dist/windows/SIM800L-Manager/SIM800L-Manager.bat
        
    - name: Create Windows archive
      shell: pwsh
      run: |
        Compress-Archive -Path dist/windows/SIM800L-Manager -DestinationPath dist/windows/SIM800L-Manager-windows-x64.zip
        
    - name: Upload Windows package
      uses: actions/upload-artifact@v4
      with:
        name: windows-package
        path: dist/windows/SIM800L-Manager-windows-x64.zip

  build-macos:
    needs: build-jar
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Download JAR
      uses: actions/download-artifact@v4
      with:
        name: jar-file
        path: target/
        
    - name: Download icon
      uses: actions/download-artifact@v4
      with:
        name: app-icon
        path: icons/
        
    - name: Convert PNG to ICNS
      run: |
        # Create iconset directory
        mkdir -p icons/app-icon.iconset
        
        # Use sips to create different sizes
        sips -z 16 16     icons/app-icon.png --out icons/app-icon.iconset/icon_16x16.png
        sips -z 32 32     icons/app-icon.png --out icons/app-icon.iconset/icon_16x16@2x.png
        sips -z 32 32     icons/app-icon.png --out icons/app-icon.iconset/icon_32x32.png
        sips -z 64 64     icons/app-icon.png --out icons/app-icon.iconset/icon_32x32@2x.png
        sips -z 128 128   icons/app-icon.png --out icons/app-icon.iconset/icon_128x128.png
        sips -z 256 256   icons/app-icon.png --out icons/app-icon.iconset/icon_128x128@2x.png
        sips -z 256 256   icons/app-icon.png --out icons/app-icon.iconset/icon_256x256.png
        sips -z 512 512   icons/app-icon.png --out icons/app-icon.iconset/icon_256x256@2x.png
        sips -z 512 512   icons/app-icon.png --out icons/app-icon.iconset/icon_512x512.png
        cp icons/app-icon.png icons/app-icon.iconset/icon_512x512@2x.png
        
        # Convert to icns
        iconutil -c icns icons/app-icon.iconset -o icons/app-icon.icns
        
    - name: Build macOS package with jpackage
      id: jpackage
      continue-on-error: true
      run: |
        jpackage \
          --input target \
          --name SIM800L-Manager \
          --main-jar SIM800LManager-v2.0.jar \
          --main-class com.sim800l.SIM800LApp \
          --type app-image \
          --dest dist/macos \
          --icon icons/app-icon.icns \
          --java-options '-Xmx512m' \
          --app-version 2.0
          
    - name: Create fallback package (if jpackage failed)
      if: steps.jpackage.outcome == 'failure'
      run: |
        mkdir -p dist/macos/SIM800L-Manager.app/Contents/MacOS
        mkdir -p dist/macos/SIM800L-Manager.app/Contents/Resources
        cp target/SIM800LManager-v2.0.jar dist/macos/SIM800L-Manager.app/Contents/Resources/
        cp icons/app-icon.png dist/macos/SIM800L-Manager.app/Contents/Resources/
        cat > dist/macos/SIM800L-Manager.app/Contents/MacOS/SIM800L-Manager << 'SCRIPT'
        #!/bin/bash
        DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../Resources" && pwd)"
        java -jar "$DIR/SIM800LManager-v2.0.jar" "$@"
        SCRIPT
        chmod +x dist/macos/SIM800L-Manager.app/Contents/MacOS/SIM800L-Manager
        cat > dist/macos/SIM800L-Manager.app/Contents/Info.plist << 'PLIST'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"\>
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>SIM800L-Manager</string>
            <key>CFBundleIdentifier</key>
            <string>com.sim800l.app</string>
            <key>CFBundleName</key>
            <string>SIM800L Manager</string>
            <key>CFBundleVersion</key>
            <string>2.0</string>
            <key>CFBundleIconFile</key>
            <string>app-icon.png</string>
        </dict>
        </plist>
        PLIST
        
    - name: Create macOS archive
      run: |
        cd dist/macos
        zip -r SIM800L-Manager-macos-x64.zip SIM800L-Manager.app
        
    - name: Upload macOS package
      uses: actions/upload-artifact@v4
      with:
        name: macos-package
        path: dist/macos/SIM800L-Manager-macos-x64.zip

  release:
    needs: [build-jar, build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          linux-package/SIM800L-Manager-linux-x64.tar.gz
          windows-package/SIM800L-Manager-windows-x64.zip
          macos-package/SIM800L-Manager-macos-x64.zip
          jar-file/SIM800LManager-v2.0.jar
        body: |
          ## SIM800L SMS Manager v2.0
          
          ### Features
          - Full Unicode support (Persian, Arabic, Chinese, emoji)
          - Dual-mode SMS: Text mode for ASCII, PDU mode for Unicode
          - Contact management and chat history
          - Modern JavaFX interface with dark/light themes
          - Cross-platform serial communication
          
          ### Platform-Specific Downloads
          
          **Linux (x64):**
          - Extract: `tar -xzf SIM800L-Manager-linux-x64.tar.gz`
          - Run: `./SIM800L-Manager/SIM800L-Manager`
          
          **Windows (x64):**
          - Extract the ZIP file
          - Run: `SIM800L-Manager\SIM800L-Manager.bat`
          
          **macOS (x64):**
          - Extract the ZIP file
          - Run: `open SIM800L-Manager.app`
          
          **Cross-Platform JAR (requires Java 17+):**
          - Run: `java -jar SIM800LManager-v2.0.jar`
          
          ### Requirements
          - No Java installation required for platform-specific packages
          - Java 17 or later required for JAR file
          - Serial port access permissions may be needed on Linux/macOS
          
          ### Security
          All 12 identified vulnerabilities have been fixed. See SECURITY.md for details.
